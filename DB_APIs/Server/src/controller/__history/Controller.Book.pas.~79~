Unit Controller.Book;

Interface

Uses
    System.JSON,
    System.Variants,
    System.Generics.Collections,
    MVCFramework,
    MVCFramework.Commons,
    MVCFramework.ActiveRecord,
    Model.Book,
    Service.Book,
    WebModule.Main;

Type
    [MVCPath(BASE_API_V1 + '/book')]
    TBookController = class(TMVCController)
    Private
        FBookService: IBookService;

    Public
        Constructor Create; override;
        Destructor Destroy; override;

        [MVCPath('/getAllBooks')]
        [MVCHTTPMethod([httpGET])]
        Procedure GetAllBooks;

        [MVCPath('/search')]
        [MVCHTTPMethod([httpGET])]
        procedure SearchBook();

        [MVCPath('/favorit')]
        [MVCHTTPMethod([httpGET])]
        procedure FavoritBook(Const [MVCFromQueryString('userid')] UserID: Int64);

        [MVCPath('/detail')]
        [MVCHTTPMethod([httpGET])]
        Procedure GetDetailByID(Const [MVCFromQueryString('bookid')] BookID: Int64;
          Const [MVCFromQueryString('userid', 0)] UserID: Int64);

        [MVCPath('/mbti')]
        [MVCHTTPMethod([httpGET])]
        Procedure MBTIBook(Const [MVCFromQueryString('searchterm', '')] SearchTerm: Integer;
          Const [MVCFromQueryString('userid')] UserID: Integer;
          Const [MVCFromQueryString('pagenum', 1)] PageNum: Integer;
          Const [MVCFromQueryString('count', 20)] Count: Integer);

        [MVCPath('')]
        [MVCHTTPMethod([httpPOST])]
        Procedure AddBook;

        [MVCPath('')]
        [MVCHTTPMethod([httpPUT])]
        Procedure UpdateBook;

        [MVCPath('/($id)')]
        [MVCHTTPMethod([httpDELETE])]
        Procedure DeleteBook(Const id: Int64);

        [MVCPath('/($id)')]
        [MVCHTTPMethod([httpGET])]
        Procedure GetBookByID(Const id: Int64);
    End;

Implementation

uses
  FireDAC.Comp.Client, System.SysUtils;

{ TBookController }

//______________________________________________________________________________
Constructor TBookController.Create;
Begin
    Inherited;
    FBookService := TBookService.Create;
End;
//______________________________________________________________________________
Destructor TBookController.Destroy;
Begin
    FBookService := nil;
    Inherited;
End;
//______________________________________________________________________________
procedure TBookController.FavoritBook(Const userID: Int64);
Var
    Books: TFDQuery;
Begin
    Books := FBookService.FavoritBook(userID);
    If Books.RecordCount > 0 Then
        Render(HTTP_STATUS.OK, Books)
    Else
        Render(HTTP_STATUS.NoContent);
End;
//______________________________________________________________________________
Procedure TBookController.GetAllBooks;
Var
    Books: TObjectList<TBook>;
Begin
    Books := FBookService.GetAllBooks;
    If Books.Count > 0 Then
        Render(HTTP_STATUS.OK, Books)
    Else
        Render(HTTP_STATUS.NoContent);
End;
//______________________________________________________________________________
Procedure TBookController.GetBookByID(Const id: Int64);
Var
    Book: TBook;
Begin
    Book := FBookService.GetBookByID(id);
    If Assigned(Book) Then
        Render(HTTP_STATUS.OK, Book)
    Else
        Render(HTTP_STATUS.NotFound);
End;
//______________________________________________________________________________
Procedure TBookController.GetDetailByID(Const BookID: Int64; Const UserID: Int64);
var
    SearchResult: TFDQuery;
Begin
    SearchResult := FBookService.GetDetailByID(BookID, UserID);
    Try
        If SearchResult.RecordCount = 0 then
            Render(HTTP_STATUS.NoContent, 'Empty')
        Else
            Render(HTTP_STATUS.OK, SearchResult);
    Except
        raise;
    End;
End;
//______________________________________________________________________________
Procedure TBookController.MBTIBook(Const SearchTerm: Integer;
Const UserID: Integer; Const PageNum: Integer; Const Count: Integer);
var
    SearchResult: TFDQuery;
    SearchTerm: string;
Begin
    SearchTerm := Context.Request.QueryStringParam('searchterm');

    SearchResult := FBookService.SearchBooks(searchterm, pageNum, count);
    Try
        If SearchResult.RecordCount = 0 then
            Render(HTTP_STATUS.NoContent, 'Empty')
        Else
            Render(SearchResult);
    Except
        raise;
    End;
End;
//______________________________________________________________________________
procedure TBookController.SearchBook();
var
    SearchResult: TFDQuery;
    SearchTerm: string;
    PageNum, Count: Integer;
Begin
    SearchTerm := Context.Request.QueryStringParam('searchterm');
    PageNum := StrToIntDef(Context.Request.QueryStringParam('pageNum'), 1);
    Count := StrToIntDef(Context.Request.QueryStringParam('count'), 20);

    SearchResult := FBookService.SearchBooks(searchterm, pageNum, count);
    Try
        If SearchResult.RecordCount = 0 then
            Render(HTTP_STATUS.NoContent, 'Empty')
        Else
            Render(SearchResult);
    Except
        raise;
    End;
end;
//______________________________________________________________________________
Procedure TBookController.AddBook;
Var
    Book: TBook;
Begin
    Book := Context.Request.BodyAs<TBook>;
    FBookService.AddBook(Book);
    Render(HTTP_STATUS.Created, 'Book added successfully');
End;
//______________________________________________________________________________
Procedure TBookController.UpdateBook;
Var
    Book: TBook;
Begin
    Book := Context.Request.BodyAs<TBook>;
    FBookService.UpdateBook(Book);
    Render(HTTP_STATUS.OK, 'Book updated successfully');
End;
//______________________________________________________________________________
Procedure TBookController.DeleteBook(Const id: Int64);
Begin
    FBookService.DeleteBook(id);
    Render(HTTP_STATUS.OK, 'Book deleted successfully');
End;
//______________________________________________________________________________


End.
